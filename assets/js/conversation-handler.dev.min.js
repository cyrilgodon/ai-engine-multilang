(()=>{(function(){"use strict";var v,y,L,N,S;const g=((v=window.eaiMLData)==null?void 0:v.pluginVersion)||"1.0.0",d=((y=window.eaiMLData)==null?void 0:y.isDebug)||!1,r=((L=window.eaiMLData)==null?void 0:L.currentLang)||"fr",f=((N=window.eaiMLData)==null?void 0:N.translations)||{},l=((S=window.eaiMLData)==null?void 0:S.localStorageKey)||"eai_ml_last_language",p="eai_ml_lang_change_timestamp",m="eai_ml_lang_alert_cooldown",E=5*60*1e3,k=10*1e3,t={info:(...e)=>{d&&console.log(`[AI Engine Multilang v${g}]`,...e)},warn:(...e)=>{d&&console.warn(`[AI Engine Multilang v${g}]`,...e)},error:(...e)=>{console.error(`[AI Engine Multilang v${g}]`,...e)}};function C(){return document.querySelector(".mwai-chatbot-container, .mwai-chatbot")?(t.info("Chatbot found on page"),!0):(t.info("No chatbot on page"),!1)}function I(){try{const e=document.querySelector(".mwai-chatbot-container");if(!e)return t.warn("Chatbot container not found, using default name"),"Reflexivo";const n=e.getAttribute("data-params");if(!n)return t.warn("data-params not found, using default name"),"Reflexivo";const o=JSON.parse(n).aiName||"Reflexivo";return t.info("Chatbot name retrieved:",o),o}catch(e){return t.error("Error getting chatbot name:",e),"Reflexivo"}}function x(e,n=2e3){let a=!1;const o=()=>document.querySelectorAll(".mwai-reply").length,i=c=>{a||(a=!0,e(c))},s=o();if(s>1){t.info(`Messages found immediately: ${s}`),i(s);return}t.info("Waiting for messages to load in DOM...");const u=new MutationObserver(()=>{const c=o();c>0&&(t.info(`Messages loaded: ${c}`),u.disconnect(),clearTimeout(R),i(c))});u.observe(document.body,{childList:!0,subtree:!0});const R=setTimeout(()=>{u.disconnect();const c=o();t.info(`Timeout reached, final count: ${c}`),i(c)},n)}function O(e){try{if(Object.keys(localStorage).filter(o=>o.startsWith("mwai-")).length===0){t.info("No active conversation found (no localStorage keys)"),e(!1);return}x(o=>{if(o<=1){t.info(`Only ${o} message(s), no popup needed`),e(!1);return}t.info(`Active conversation detected with ${o} messages`),e(!0)})}catch(n){t.error("Error checking active conversation:",n),e(!1)}}function M(){try{const e=localStorage.getItem(m);if(!e)return!1;const n=Date.now(),a=parseInt(e,10)-n;return a>0?(t.info(`Cooldown active: ${Math.round(a/1e3)}s remaining`),!0):(localStorage.removeItem(m),!1)}catch(e){return t.error("Error checking cooldown:",e),!1}}function b(){try{const e=Date.now()+E;localStorage.setItem(m,e.toString()),t.info(`Cooldown activated until ${new Date(e).toLocaleTimeString()}`)}catch(e){t.error("Error activating cooldown:",e)}}function h(e){return((f[r]||f.fr||{}).langNames||{})[e]||e}function D(e,n){return e.replace(/\{newLang\}/g,n.newLang||"").replace(/\{oldLang\}/g,n.oldLang||"").replace(/\{botName\}/g,n.botName||"").replace(/\{clearBtn\}/g,n.clearBtn||"")}function B(){try{const e=localStorage.getItem(p);return e&&Date.now()-parseInt(e,10)<k?(t.info("Recent language change detected (on current page)"),!0):!1}catch(e){return t.error("Error checking recent language change:",e),!1}}function _(){try{const e=document.querySelector(".mwai-chatbot");if(!e)return t.warn("Chatbot element not found for Clear button name"),"Nouvelle conversation";const n=e.getAttribute("data-params");if(!n)return t.warn("data-params not found, using default Clear button name"),"Nouvelle conversation";const o=JSON.parse(n).textClear||"Nouvelle conversation";return t.info("Clear button name retrieved:",o),o}catch(e){return t.error("Error getting Clear button name:",e),"Nouvelle conversation"}}function T(e){const n=I(),a=h(r),o=h(e),i=_(),s={newLang:a,oldLang:o,botName:n,clearBtn:i},u=f[r]||{};return{title:u.title||"Language change detected",message:D(u.message||'You changed the language to {newLang}. To start a new conversation in {newLang}, click on the <strong>"{clearBtn}"</strong> button.',s),btnOk:u.btnOk||"Got it"}}function P(){t.info("Restarting conversation...");try{const e=[".mwai-chatbot .mwai-clear-button",".mwai-chatbot .mwai-reset-button",'.mwai-chatbot button[aria-label*="clear"]','.mwai-chatbot button[aria-label*="restart"]'];let n=null;for(const a of e)if(n=document.querySelector(a),n){t.info("Clear button found with selector:",a);break}if(n)n.click(),t.info("Clear button clicked");else{t.warn("Clear button not found, fallback: clear input field only");const a=document.querySelector('.mwai-chatbot input[type="text"], .mwai-chatbot textarea');a&&(a.value="",t.info("Input field cleared (fallback)"))}localStorage.setItem(l,r),t.info(`Last language updated to: ${r}`)}catch(e){t.error("Error restarting conversation:",e)}}function A(e){if(document.getElementById("eai-ml-popup-overlay")){t.info("Popup already displayed, skipping");return}const n=T(e),a=`
			<div id="eai-ml-popup-overlay" style="
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				z-index: 999999;
				display: flex;
				align-items: center;
				justify-content: center;
			">
				<div id="eai-ml-popup" style="
					background: white;
					border-radius: 12px;
					padding: 30px;
					max-width: 500px;
					width: 90%;
					box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
					font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				">
					<h2 style="
						margin: 0 0 15px 0;
						font-size: 22px;
						font-weight: 600;
						color: #1a1a1a;
					">${n.title}</h2>
					<p style="
						margin: 0 0 25px 0;
						font-size: 16px;
						line-height: 1.5;
						color: #4a4a4a;
					">${n.message}</p>
					<div style="
						display: flex;
						justify-content: flex-end;
					">
						<button id="eai-ml-btn-ok" style="
							background: #007aff;
							border: none;
							border-radius: 6px;
							padding: 12px 24px;
							font-size: 15px;
							font-weight: 500;
							color: white;
							cursor: pointer;
							transition: background 0.2s;
						">${n.btnOk}</button>
					</div>
				</div>
			</div>
		`;document.body.insertAdjacentHTML("beforeend",a);const o=document.getElementById("eai-ml-btn-ok"),i=document.getElementById("eai-ml-popup-overlay");if(t.info("Event listeners setup",{btnOk:!!o,overlay:!!i}),!o||!i){t.error("Failed to find popup elements!");return}o.addEventListener("click",()=>{t.info("User acknowledged language change"),localStorage.setItem(l,r),b(),i.remove()}),i.addEventListener("click",s=>{s.target===i&&(t.info("Popup closed by clicking overlay"),localStorage.setItem(l,r),b(),i.remove())}),o.addEventListener("mouseenter",()=>{o.style.background="#0056b3"}),o.addEventListener("mouseleave",()=>{o.style.background="#007aff"}),t.info("Popup displayed")}function $(){t.info("Detecting language change...",{currentLang:r,lastLang:localStorage.getItem(l)});try{if(!C()){t.info("No chatbot on page, skipping language change detection");return}const e=localStorage.getItem(l);if(!e){t.info("First visit, storing current language:",r),localStorage.setItem(l,r);return}if(e===r){t.info("No language change detected");return}if(t.info(`Language change detected: ${e} \u2192 ${r}`),M()){t.info("Cooldown active, skipping popup");return}O(n=>{if(!n){t.info("No active conversation, silent language change"),localStorage.setItem(l,r);return}localStorage.setItem(p,Date.now().toString()),A(e)})}catch(e){t.error("Error detecting language change:",e)}}function w(){if(t.info("Initializing...",{version:g,currentLang:r,isDebug:d}),!window.eaiMLData){t.error("eaiMLData not found! Plugin may not work correctly.");return}$(),t.info("Initialization complete")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",w):w()})();})();
